              - "true_false": needs "correctAnswer" (boolean).
              - "fill_in_the_blank": needs "question" with "___" and "correctAnswer" (string for the blank).
              - "short_answer": needs "referenceAnswer" (concise correct answer).
              - "long_answer": needs "referenceAnswer" (detailed correct answer).
              Text: ${inputText}`;
              const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
              const apiKey = "AIzaSyDhF81uX1JMsQhpqiMtVzvJbvVqpywhyAs";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
              
              const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              
              const result = await response.json();
              let rawQuizText = result.candidates[0].content.parts[0].text;

              if (rawQuizText.startsWith('```json') && rawQuizText.endsWith('```')) {
                  rawQuizText = rawQuizText.substring(7, rawQuizText.length - 3).trim();
              } else if (rawQuizText.startsWith('```') && rawQuizText.endsWith('```')) {
                  rawQuizText = rawQuizText.substring(3, rawQuizText.length - 3).trim();
              }

              let parsedQuiz;
              try {
                  parsedQuiz = JSON.parse(rawQuizText);
              } catch (parseError) {
                  console.error("JSON Parse error:", parseError);
                  throw new Error(`Failed to parse quiz data. The AI response might be malformed. Raw response: ${rawQuizText.substring(0, 200)}...`);
              }
              
              if (Array.isArray(parsedQuiz) && parsedQuiz.length > 0) {
                setQuizData(parsedQuiz); setQuizQueue([...parsedQuiz]); setView('quiz');
              } else {
                setError("AI returned an empty or invalid quiz.");
              }
            } catch (e) {
              console.error("Quiz generation error:", e);
              setError(`Failed to generate quiz. ${e.message}`);
            } finally {
              setLoading(false);
            }
          };

          const evaluateTextAnswer = async (userAnswer, question) => {
            setIsEvaluating(true); setEvaluationFeedback(null);
            try {
              const prompt = `Evaluate the user's answer. Question: "${question.question}". Reference Answer: "${question.referenceAnswer || question.correctAnswer}". User's Answer: "${userAnswer}". Output JSON with "evaluation" ("correct", "partially correct", "incorrect") and a concise "reason".`;
              const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
              const apiKey = "AIzaSyDhF81uX1JMsQhpqiMtVzvJbvVqpywhyAs";
              const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

              const response = await fetchWithRetry(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              
              const result = await response.json();
              let rawEvaluationText = result.candidates[0].content.parts[0].text;
